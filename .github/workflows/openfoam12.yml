name: OpenFOAM 12 Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t clotfoam:openfoam12 -f docker/Dockerfile .
    
    - name: Save Docker image
      run: |
        docker save clotfoam:openfoam12 -o clotfoam-image.tar
    
    - name: Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: clotfoam-image.tar
        retention-days: 1

  test-rectangle2d:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
    
    - name: Load Docker image
      run: docker load -i clotfoam-image.tar
    
    - name: Test rectangle2D
      run: |
        mkdir -p test-output
        docker run --rm \
          -v $(pwd)/test-output:/test-output \
          clotfoam:openfoam12 \
          /bin/bash -c "
            /home/ofuser/docker/run-test.sh
            EXIT_CODE=\$?
            mkdir -p /test-output
            cp /home/ofuser/tutorials/rectangle2D/log.* /test-output/ 2>/dev/null || true
            exit \$EXIT_CODE
          "
    
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-rectangle2d
        path: test-output/
        if-no-files-found: ignore

  test-tjunction2d:
    needs: test-rectangle2d
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
    
    - name: Load Docker image
      run: docker load -i clotfoam-image.tar
    
    - name: Test Tjunction2D
      run: |
        mkdir -p test-output
        docker run --rm \
          -v $(pwd)/test-output:/test-output \
          clotfoam:openfoam12 \
          /bin/bash -c "
            source /usr/lib/openfoam/openfoam2412/etc/bashrc
            export WM_PROJECT_USER_DIR=/home/ofuser/OpenFOAM/ofuser-v2412
            export FOAM_USER_APPBIN=/home/ofuser/OpenFOAM/ofuser-v2412/platforms/linuxARM64GccDPInt32Opt/bin
            export FOAM_USER_LIBBIN=/home/ofuser/OpenFOAM/ofuser-v2412/platforms/linuxARM64GccDPInt32Opt/lib
            export PATH=\$FOAM_USER_APPBIN:\$PATH
            
            # Compile first
            cd /home/ofuser/clotFoam && wclean && wmake
            
            # Run test and capture exit code
            /home/ofuser/docker/test-tjunction2d.sh
            EXIT_CODE=\$?
            
            # Always copy logs
            mkdir -p /test-output
            cp /home/ofuser/tutorials/Tjunction2D/log.* /test-output/ 2>/dev/null || true
            
            # Print logs on failure for CI visibility
            if [ \$EXIT_CODE -ne 0 ] && [ -f /home/ofuser/tutorials/Tjunction2D/log.clotFoam ]; then
              echo '=== SOLVER LOG (last 100 lines) ==='
              tail -100 /home/ofuser/tutorials/Tjunction2D/log.clotFoam
            fi
            
            exit \$EXIT_CODE
          "
    
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-tjunction2d
        path: test-output/
        if-no-files-found: ignore

  test-hjunction3d:
    needs: test-tjunction2d
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
    
    - name: Load Docker image
      run: docker load -i clotfoam-image.tar
    
    - name: Test Hjunction3D
      run: |
        mkdir -p test-output
        docker run --rm \
          -v $(pwd)/test-output:/test-output \
          clotfoam:openfoam12 \
          /bin/bash -c "
            source /usr/lib/openfoam/openfoam2412/etc/bashrc
            export WM_PROJECT_USER_DIR=/home/ofuser/OpenFOAM/ofuser-v2412
            export FOAM_USER_APPBIN=/home/ofuser/OpenFOAM/ofuser-v2412/platforms/linuxARM64GccDPInt32Opt/bin
            export FOAM_USER_LIBBIN=/home/ofuser/OpenFOAM/ofuser-v2412/platforms/linuxARM64GccDPInt32Opt/lib
            export PATH=\$FOAM_USER_APPBIN:\$PATH
            
            # Compile first
            cd /home/ofuser/clotFoam && wclean && wmake
            
            # Run test and capture exit code
            /home/ofuser/docker/test-hjunction3d.sh
            EXIT_CODE=\$?
            
            # Always copy logs
            mkdir -p /test-output
            cp /home/ofuser/tutorials/Hjunction3D/log.* /test-output/ 2>/dev/null || true
            
            # Print logs on failure for CI visibility
            if [ \$EXIT_CODE -ne 0 ] && [ -f /home/ofuser/tutorials/Hjunction3D/log.clotFoam ]; then
              echo '=== SOLVER LOG (last 100 lines) ==='
              tail -100 /home/ofuser/tutorials/Hjunction3D/log.clotFoam
            fi
            
            exit \$EXIT_CODE
          "
    
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-hjunction3d
        path: test-output/
        if-no-files-found: ignore
