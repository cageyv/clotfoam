name: openfoam

on:
  push:
  pull_request:

jobs:
  openfoam12-apt:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set executable bits
        shell: bash
        run: |
          chmod +x ci/build.sh ci/smoke.sh
          chmod +x ci/install-openfoam12-ubuntu.sh

      - name: Install OpenFOAM v12 (Ubuntu packages)
        shell: bash
        run: |
          ./ci/install-openfoam12-ubuntu.sh

      - name: Build + smoke test (rectangle2D)
        shell: bash
        run: |
          CI_ARTIFACTS_DIR="${{ github.workspace }}/.ci-artifacts/v12" CI=1 ./ci/smoke.sh

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openfoam-v12-logs
          path: |
            .ci-artifacts/v12/**/log.*

  openfoam2412-docker:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set executable bits
        shell: bash
        run: |
          chmod +x ci/build.sh ci/smoke.sh

      - name: Docker pull (OpenFOAM-dev 2412)
        shell: bash
        run: |
          docker pull opencfd/openfoam-dev:2412

      - name: Build + smoke test (rectangle2D)
        shell: bash
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            -e CI=1 \
            -e CI_ARTIFACTS_DIR="/work/.ci-artifacts/v2412" \
            opencfd/openfoam-dev:2412 \
            bash -lc "./ci/smoke.sh"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openfoam-v2412-logs
          path: |
            .ci-artifacts/v2412/**/log.*

