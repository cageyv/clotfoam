name: openfoam

on:
  push:
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - foam: v12
            image: openfoam/openfoam12:latest
            fallback_images: |
              openfoam/openfoam12:latest
          - foam: v2412
            image: openfoam/openfoam2412:latest
            fallback_images: |
              openfoam/openfoam2412:latest
              openfoam/openfoam2412-default:latest
              opencfd/openfoam2412:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set executable bits
        shell: bash
        run: |
          chmod +x ci/build.sh ci/smoke.sh

      - name: Select OpenFOAM Docker image
        shell: bash
        run: |
          set -euo pipefail
          chosen=""
          while IFS= read -r img; do
            [[ -z "${img// /}" ]] && continue
            echo "Trying image: $img"
            if docker pull "$img"; then
              chosen="$img"
              break
            fi
          done <<< "${{ matrix.fallback_images }}"

          if [[ -z "$chosen" ]]; then
            echo "ERROR: Could not pull any OpenFOAM image candidates." >&2
            exit 1
          fi

          echo "OPENFOAM_IMAGE=$chosen" >> "$GITHUB_ENV"

      - name: Build + smoke test (rectangle2D)
        shell: bash
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            -e CI=1 \
            -e CI_ARTIFACTS_DIR="/work/.ci-artifacts/${{ matrix.foam }}" \
            "$OPENFOAM_IMAGE" \
            bash -lc "./ci/smoke.sh"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openfoam-${{ matrix.foam }}-logs
          path: |
            .ci-artifacts/${{ matrix.foam }}/**/log.*

